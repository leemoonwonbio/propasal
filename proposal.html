<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ⭐ 이 함수가 가장 중요합니다.
        function getDataFromUrl() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const dataParam = urlParams.get('data');
                if (dataParam) {
                    // URL 인코딩을 해석(디코딩)하는 decodeURIComponent() 함수를 사용합니다.
                    // atob() 함수는 더 이상 사용하지 않습니다.
                    const decodedData = JSON.parse(decodeURIComponent(dataParam));
                    return decodedData;
                }
            } catch (error) {
                console.error("URL 데이터 파싱 오류:", error);
            }
            // URL에 데이터가 없거나 오류 발생 시 사용할 샘플 데이터입니다.
            console.warn("URL 파라미터('data')를 찾을 수 없어 샘플 데이터로 페이지를 초기화합니다.");
            return {
                patient: { name: "OOO" },
                proposal: [ { name: 'Body Recording Core', value: 6 }, { name: 'LEEMOONWON Shampoo 200ml', value: 2 } ],
                notes: "환자분의 현재 상태에 맞춰 제안된 초기 플랜입니다. 필요에 따라 자유롭게 수정하실 수 있습니다."
            };
        }

        const productMaster = {
            'Body Recording Core_1': { name: 'Body Recording Core', duration: 1, p1: 480000, type: 'duration', desc: "...", shopifyVariantId: '4123456789' },
            'Body Recording Core_3': { name: 'Body Recording Core', duration: 3, p1: 480000, p3: 432000, type: 'duration', desc: "...", shopifyVariantId: '4123456790' },
            'Body Recording Core_6': { name: 'Body Recording Core', duration: 6, p1: 480000, p6: 408000, type: 'duration', desc: "...", shopifyVariantId: '4123456791' },
            'Body Recording Core_12': { name: 'Body Recording Core', duration: 12, p1: 480000, p12: 384000, type: 'duration', desc: "...", shopifyVariantId: '4123456792' },
            'LEEMOONWON Shampoo 200ml': { name: 'LEEMOONWON Shampoo 200ml', p1: 65000, type: 'quantity', desc: "...", shopifyVariantId: '4123456800' },
        };

        let cartItems = [];
        const shopifyDomain = 'your-store-name.myshopify.com';

        function loadProposalData() {
            const proposalData = getDataFromUrl();

            document.getElementById('customer-name').textContent = proposalData.patient.name;
            document.getElementById('doctor-notes-display').textContent = proposalData.notes;

            cartItems = proposalData.proposal.map(item => ({...item}));
            updateCartDisplay();
        }

        // (이하 updateCartDisplay, findProductInfo 등 나머지 모든 함수는 기존과 동일합니다)
        // ... (기존 HTML에 있던 나머지 JS 코드를 여기에 그대로 두세요) ...

        initializeUI();
    });
</script>

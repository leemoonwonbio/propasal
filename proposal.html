<script>
    document.addEventListener('DOMContentLoaded', async () => { // async 추가
        // --- Shopify API 설정 ---
        const shopifyDomain = 'https://8jufk8-tg.myshopify.com/'; // ⭐ 실제 쇼피파이 도메인
        const storefrontAccessToken = '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'; // ⭐ 1단계에서 복사한 토큰
        const apiEndpoint = `https://${shopifyDomain}/api/2023-10/graphql.json`;

        // productMaster는 이제 가격 대신 Shopify의 Variant ID만 관리합니다.
        const productMaster = {
            'Body Recording Core_1': { name: 'Body Recording Core', type: 'duration', shopifyVariantId: '4123456789' },
            'Body Recording Core_3': { name: 'Body Recording Core', type: 'duration', shopifyVariantId: '4123456790' },
            'Body Recording Core_6': { name: 'Body Recording Core', type: 'duration', shopifyVariantId: '4123456791' },
            'Body Recording Core_12': { name: 'Body Recording Core', type: 'duration', shopifyVariantId: '4123456792' },
            'LEEMOONWON Shampoo 200ml': { name: 'LEEMOONWON Shampoo 200ml', type: 'quantity', shopifyVariantId: '4123456800' },
        };
        
        let cartItems = [];
        let shopifyPrices = {}; // Shopify에서 가져온 가격을 저장할 객체

        // URL에서 제안 데이터 가져오는 함수 (기존과 동일)
        function getDataFromUrl() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const dataParam = urlParams.get('data');
                if (dataParam) {
                    return JSON.parse(decodeURIComponent(dataParam));
                }
            } catch (error) { console.error("URL 데이터 파싱 오류:", error); }
            return { patient: { name: "OOO(샘플)" }, proposal: [], notes: "샘플 소견입니다." };
        }

        // ⭐ [신규] Shopify에서 상품 가격을 가져오는 함수
        async function fetchShopifyPrices(variantIds) {
            const query = `
                query getVariantPrices($ids: [ID!]!) {
                    nodes(ids: $ids) {
                        ... on ProductVariant {
                            id
                            price {
                                amount
                            }
                        }
                    }
                }`;
            
            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Shopify-Storefront-Access-Token': storefrontAccessToken,
                    },
                    body: JSON.stringify({
                        query: query,
                        variables: { ids: variantIds }
                    }),
                });

                const jsonResponse = await response.json();
                const prices = {};
                jsonResponse.data.nodes.forEach(variant => {
                    if (variant) {
                        prices[variant.id] = parseFloat(variant.price.amount);
                    }
                });
                return prices;
            } catch (error) {
                console.error('Shopify 가격 조회 오류:', error);
                alert('Shopify에서 가격 정보를 불러오는 데 실패했습니다.');
                return {};
            }
        }

        // ⭐ [수정] 가격 계산 함수
        function calculatePrice(item) {
            const productKey = `${item.name}_${item.value}`;
            const productInfo = productMaster[productKey] || Object.values(productMaster).find(p => p.name === item.name);
            if (!productInfo) return { price: 0 };
            
            // Shopify Variant ID를 'gid://shopify/ProductVariant/VARIANT_ID' 형식으로 변환
            const fullVariantId = `gid://shopify/ProductVariant/${productInfo.shopifyVariantId}`;
            
            const price = shopifyPrices[fullVariantId] || 0;

            if (productInfo.type === 'quantity') {
                return { price: price * item.value };
            }
            return { price: price }; // 기간제 상품은 이미 해당 기간의 가격이므로 수량을 곱하지 않음
        }

        // ⭐ [수정] 장바구니 표시 함수
        function updateCartDisplay() {
            const cartItemsContainer = document.getElementById('cart-items');
            cartItemsContainer.innerHTML = ''; // 기존 내용 비우기
            let finalTotal = 0;
            
            cartItems.forEach((item, index) => {
                const productKey = `${item.name}_${item.value}`;
                const productInfo = productMaster[productKey] || Object.values(productMaster).find(p => p.name === item.name);
                if (!productInfo) return;

                const { price } = calculatePrice(item);
                finalTotal += price;

                // (이하 div 생성 및 innerHTML 설정 로직은 기존과 유사하게 구현)
                // ... 가격 표시 부분에 price 변수 사용 ...
            });
            // 최종 합계 업데이트
            document.getElementById('final-total').textContent = `${finalTotal.toLocaleString()} 원`;
        }

        // ⭐ [수정] 페이지 초기화 메인 로직
        async function initializePage() {
            const proposalData = getDataFromUrl();
            document.getElementById('customer-name').textContent = proposalData.patient.name;
            document.getElementById('doctor-notes-display').textContent = proposalData.notes;
            cartItems = proposalData.proposal ? [...proposalData.proposal] : [];
            
            if (cartItems.length > 0) {
                // 1. 장바구니의 모든 상품에 대한 Shopify Variant ID 목록 생성
                const variantIdsToFetch = cartItems.map(item => {
                    const productKey = `${item.name}_${item.value}`;
                    const productInfo = productMaster[productKey] || Object.values(productMaster).find(p => p.name === item.name);
                    return `gid://shopify/ProductVariant/${productInfo.shopifyVariantId}`;
                });
                
                // 2. Shopify API를 호출하여 가격 정보 가져오기
                shopifyPrices = await fetchShopifyPrices(variantIdsToFetch);
                
                // 3. 가격 정보 로딩 후 화면 업데이트
                updateCartDisplay();
            }

            // (이하 initializeUI의 나머지 부분 및 이벤트 리스너는 기존과 동일하게 유지)
        }

        initializePage();
    });
</script>
